// Generated by CoffeeScript 1.8.0
var Modem, args, buildOptions, command, commands, fs, minimist, modem, options, parallel, url_parse, usage;

require('colors');

usage = "\nUsage: " + 'docke'.cyan + " command\n\nCommands:\n  \n  ping      Test the connection to docker\n  ps        List the running dockers and their ip addresses\n";

url_parse = require('url').parse;

fs = require('fs');

Modem = require('./modem');

parallel = function(tasks, callback) {
  var count, result;
  count = tasks.length;
  result = function(cb) {
    var task, _i, _len, _results;
    if (count === 0) {
      return cb();
    }
    _results = [];
    for (_i = 0, _len = tasks.length; _i < _len; _i++) {
      task = tasks[_i];
      _results.push(task(function() {
        count--;
        if (count === 0) {
          return cb();
        }
      }));
    }
    return _results;
  };
  if (callback != null) {
    result(callback);
  }
  return result;
};

buildOptions = function(args) {
  var path, result;
  result = {
    host: url_parse(process.env.DOCKER_HOST || 'unix:///var/run/docker.sock'),
    port: process.env.DOCKER_PORT
  };
  if (process.env.DOCKER_TLS_VERIFY !== '' || false && (process.env.DOCKER_CERT_PATH != null)) {
    path = process.env.DOCKER_CERT_PATH;
    result.ca = fs.readFileSync("" + path + "/ca.pem");
    result.cert = fs.readFileSync("" + path + "/cert.pem");
    result.key = fs.readFileSync("" + path + "/key.pem");
    result.https = {
      cert: result.cert,
      key: result.key,
      ca: result.ca
    };
  }
  return result;
};

commands = {
  ping: function() {
    return modem.get('/_ping', function(err, result) {
      if (err != null) {
        return console.error(err);
      }
      if (result === 'OK') {
        return console.log('Docker is up'.green);
      } else {
        console.error('Docker is down'.red);
        return process.exit(1);
      }
    });
  },
  ps: function() {
    return modem.get('/containers/json', function(err, containers) {
      var container, results, tasks, _fn, _i, _len;
      if (err != null) {
        return console.error(err);
      }
      results = [];
      tasks = [];
      _fn = function(container) {
        return tasks.push(function(cb) {
          return modem.get("/containers/" + container.Id + "/json", function(err, inspect) {
            if (err != null) {
              console.error(err);
            }
            results.push({
              container: container,
              inspect: inspect
            });
            return cb();
          });
        });
      };
      for (_i = 0, _len = containers.length; _i < _len; _i++) {
        container = containers[_i];
        _fn(container);
      }
      return parallel(tasks, function() {
        var ip, result, _j, _len1, _results;
        results.sort(function(a, b) {
          a = a.container.Names[0];
          b = b.container.Names[0];
          if (a > b) {
            return 1;
          }
          if (a < b) {
            return -1;
          }
          return 0;
        });
        _results = [];
        for (_j = 0, _len1 = results.length; _j < _len1; _j++) {
          result = results[_j];
          ip = result.inspect.NetworkSettings.IPAddress.toString();
          while (ip.length < 16) {
            ip += ' ';
          }
          _results.push(console.log("" + ip.blue + " " + result.container.Names[0].slice(1)));
        }
        return _results;
      });
    });
  },
  test: function() {
    return modem.get('/containers/json', function(err, result) {
      if (err != null) {
        return console.error(err);
      }
      return console.log(result);
    });
  }
};

minimist = require('minimist');

args = minimist(process.argv.slice(2), {
  "default": {
    'http-addr': '127.0.0.1:8500'
  }
});

if (args._.length === 0) {
  console.error(usage);
  process.exit(1);
}

command = args._[0];

if (commands[command] == null) {
  console.error("Unknown command " + command.cyan);
  console.error(usage);
  process.exit(1);
}

options = buildOptions(args);

modem = new Modem(options);

commands[command]();
